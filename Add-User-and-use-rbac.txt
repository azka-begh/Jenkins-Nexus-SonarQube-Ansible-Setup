openssl genpkey -out john.key -algorithm Ed25519
openssl req -new -key john.key -out john.csr -subj "/CN=john,/O=edit"
cat john.csr | base64 | tr -d "\n"

cat <<EOF | kubectl apply -f -
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: john
spec:
  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlHZU1GSUNBUUF3SHpFT01Bd0dBMVVFQXd3RmFtOW9iaXd4RFRBTEJnTlZCQW9NQkdWa2FYUXdLakFGQmdNcgpaWEFESVFEbk9nYXEzSEcyMkw1dFROZ0JaQ1lHYkJiSjdXQ05BTmE2aWhsNll0NWFkNkFBTUFVR0F5dGxjQU5CCkFPeVJaZlpKY2c3eE90eHBjUmFqZmlySk9WcVkvaE9CQldneEJubERFek4rbXpJRm12MkU5czNoaXBQZjBOYk8KMkNrR0pNR0NhOXJabStVRHowelhqZ009Ci0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=
  signerName: kubernetes.io/kube-apiserver-client
  expirationSeconds: 86400  # one day
  usages:
  - client auth
EOF

kubectl certificate approve john

kubectl describe csr/john 
kubectl get csr/john -o jsonpath="{.status.certificate}" | base64 -d > john.crt
cp ~/.kube/config john-kube-config   #always backup
kubectl config get-clusters

# Not using the main config, using the backed up one
kubectl config set-credentials john --client-key john.key --client-certificate john.csr --embed-certs=true

kubectl create role pod-manager --verb=create,list,get --resource=pods --namespace=default --dry-run=client -o yaml > pod-manager-role.yml
kubectl create rolebinding bind-pod-manager --role=pod-manager --user=john --dry-run=client -o yaml > pod-manager-rolebind.yml

kubectl apply -f pod-manager-role.yml
kubectl apply -f pod-manager-rolebind.yml

kubectl auth can-i create deployments --namespace=default --as=john
kubectl auth can-i create secrets --namespace=default --as=john
kubectl auth can-i get pods --namespace=default --as=john

kubectl config set-context john-context --cluster=k8skops.aab12.xyz --user=john --namespace=default
kubectl config get-contexts
kubectl config use-context john-context
kubectl get pods
